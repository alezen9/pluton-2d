---
import BaseLayout from "../../layouts/Layout.astro";
import { getCollection } from "astro:content";
import { exampleCategoryOrder } from "../../content.config";
import { hiddenExampleCategories } from "../../content.config";
import type { ExampleCategory } from "../../content.config";

const { title = "Examples" } = Astro.props;
const baseUrl = import.meta.env.BASE_URL.replace(/\/$/, "");
const normalizeUrlPath = (urlPath: string) =>
  urlPath.length > 1 ? urlPath.replace(/\/+$/, "") : urlPath;
const currentUrlPath = normalizeUrlPath(Astro.url.pathname);

const exampleCollection = await getCollection("examples");
const isHiddenExample = (entryId: string, category: ExampleCategory) =>
  entryId.startsWith("drafts/") || hiddenExampleCategories.includes(category);

type ExampleNavigationItem = {
  path: string;
  label: string;
};

const exampleItemsByCategory: Partial<
  Record<ExampleCategory, ExampleNavigationItem[]>
> = {};
for (const exampleEntry of exampleCollection) {
  const category = exampleEntry.data.category;
  if (isHiddenExample(exampleEntry.id, category)) continue;
  const arr = exampleItemsByCategory[category] ?? [];
  arr.push({
    path: `/examples/${exampleEntry.id}`,
    label: exampleEntry.data.title,
  });
  exampleItemsByCategory[category] = arr;
}

const categorizedExampleNavigation = exampleCategoryOrder
  .filter((category) => !hiddenExampleCategories.includes(category))
  .filter((category) => exampleItemsByCategory[category])
  .map((category) => ({
    label: category,
    items: exampleItemsByCategory[category] ?? [],
  }));

const isActiveExampleLink = (href: string) =>
  normalizeUrlPath(href) === currentUrlPath;
---

<BaseLayout {title} currentPage="/examples">
  <div class="examples-layout">
    <aside class="examples-sidebar">
      <div class="sidebar-category">
        <ul class="sidebar-links">
          <li>
            <a
              href={`${baseUrl}/examples`}
              class:list={{
                active: isActiveExampleLink(`${baseUrl}/examples`),
              }}>All Examples</a
            >
          </li>
        </ul>
      </div>
      {
        categorizedExampleNavigation.map((categoryGroup) => (
          <div class="sidebar-category">
            <div class="sidebar-category-label">{categoryGroup.label}</div>
            <ul class="sidebar-links">
              {categoryGroup.items.map((item) => (
                <li>
                  <a
                    href={`${baseUrl}${item.path}`}
                    class:list={{
                      active: isActiveExampleLink(`${baseUrl}${item.path}`),
                    }}
                  >
                    {item.label}
                  </a>
                </li>
              ))}
            </ul>
          </div>
        ))
      }
    </aside>
    <div class="examples-main">
      <slot />
    </div>
  </div>
</BaseLayout>

<style>
  .examples-layout {
    display: flex;
    height: calc(100svh - 64px);
    position: relative;
    z-index: 1;
    overflow: hidden;
  }

  .examples-sidebar {
    width: 300px;
    flex-shrink: 0;
    border-right: 1px solid var(--panel-border);
    background: var(--panel-bg-solid);
    padding: 1.2rem 0.72rem;
    overflow-y: auto;
  }

  .examples-sidebar .sidebar-category {
    margin-bottom: 1rem;
  }

  .examples-sidebar .sidebar-category-label {
    font-size: 0.75rem;
    text-transform: uppercase;
    letter-spacing: 0.1em;
    font-weight: bold;
    color: var(--text-muted);
    padding: 0 0.5rem;
    margin-bottom: 0.3rem;
  }

  .examples-sidebar .sidebar-links {
    list-style: none;
    display: flex;
    flex-direction: column;
    gap: 1px;
    margin: 0;
    padding: 0;
  }

  .examples-sidebar .sidebar-links a {
    display: block;
    padding: 0.3rem 0.54rem;
    border-radius: 4px;
    color: var(--text-muted);
    opacity: 0.75;
    text-decoration: none;
    font-size: 0.8rem;
    font-weight: 500;
    transition:
      color 0.15s,
      background 0.15s;
  }

  .examples-sidebar .sidebar-category + .sidebar-category .sidebar-links {
    padding-left: 1.25rem;
  }

  .examples-sidebar .sidebar-links a:hover {
    color: var(--text-main);
    background: var(--tab-hover-bg);
    text-decoration: none;
  }

  .examples-sidebar .sidebar-links a.active {
    color: var(--accent);
    background: var(--accent-light);
  }

  .examples-main {
    flex: 1;
    padding: 1.35rem 1.8rem;
    display: flex;
    flex-direction: column;
    overflow-y: auto;
    min-width: 0;
  }

  @media (max-width: 768px) {
    .examples-layout {
      flex-direction: column;
      height: auto;
      min-height: calc(100vh - 60px);
      overflow: visible;
    }

    .examples-sidebar {
      width: 100%;
      height: auto;
      border-right: none;
      border-bottom: 1px solid var(--panel-border);
      padding: 0.75rem 1rem;
      display: flex;
      gap: 0.75rem;
      overflow-x: auto;
      overflow-y: hidden;
      -webkit-overflow-scrolling: touch;
      scrollbar-width: none;
    }

    .examples-sidebar::-webkit-scrollbar {
      display: none;
    }

    .examples-sidebar .sidebar-category {
      margin-bottom: 0;
      flex-shrink: 0;
    }

    .examples-sidebar .sidebar-category-label {
      display: none;
    }

    .examples-sidebar .sidebar-links {
      flex-direction: row;
      gap: 0.4rem;
      padding-left: 0;
    }

    .examples-sidebar .sidebar-links a {
      white-space: nowrap;
      padding: 0.3rem 0.66rem;
      border: 1px solid var(--panel-border);
      font-size: 0.82rem;
    }

    .examples-sidebar .sidebar-links a.active {
      border-color: var(--accent);
    }

    .examples-main {
      padding: 1rem;
      overflow: visible;
    }
  }
</style>
