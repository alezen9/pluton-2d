---
import Layout from "../../layouts/Layout.astro";
import { getCollection } from "astro:content";

const { title = "Examples" } = Astro.props;
const base = import.meta.env.BASE_URL.replace(/\/$/, "");

const examples = await getCollection("examples");

const CATEGORY_ORDER = ["Drawing", "Profiles", "Effects", "Behavior"];

const byCategory = {};
for (const ex of examples) {
  (byCategory[ex.data.category] ??= []).push({
    path: `/examples/${ex.id}`,
    label: ex.data.title,
  });
}

const categories = CATEGORY_ORDER.filter((c) => byCategory[c]).map((c) => ({
  label: c,
  items: byCategory[c],
}));
---

<Layout {title} currentPage="/examples">
  <div class="examples-layout">
    <aside class="examples-sidebar" transition:persist>
      {categories.map((cat) => (
        <div class="sidebar-category">
          <div class="sidebar-category-label">{cat.label}</div>
          <ul class="sidebar-links">
            {cat.items.map((item) => (
              <li>
                <a href={`${base}${item.path}`}>
                  {item.label}
                </a>
              </li>
            ))}
          </ul>
        </div>
      ))}
    </aside>
    <div class="examples-main">
      <slot />
    </div>
  </div>
</Layout>

<script>
  // Update active link after view transitions (sidebar is persisted, doesn't re-render)
  const setActive = () => {
    const path = window.location.pathname;
    document.querySelectorAll(".examples-sidebar a").forEach((a) => {
      a.classList.toggle("active", a.getAttribute("href") === path);
    });
  };
  setActive();
  document.addEventListener("astro:after-swap", setActive);
</script>
